<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devmatch.mapper.ApplicationMapper">

    <!-- 결과 매핑 -->
    <resultMap id="applicationMap" type="com.devmatch.dto.ApplicationDTO">
        <id property="applicationId" column="application_id"/>
        <result property="postingId" column="posting_id"/>
        <result property="memberId" column="member_id"/>
        <result property="resumeId" column="resume_id"/>
        <result property="coverLetter" column="cover_letter"/>
        <result property="status" column="status"/>
        <result property="matchScore" column="match_score"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <!-- 조인 필드 -->
        <result property="postingTitle" column="posting_title"/>
        <result property="companyName" column="company_name"/>
        <result property="applicantName" column="applicant_name"/>
        <result property="applicantEmail" column="applicant_email"/>
        <result property="resumeTitle" column="resume_title"/>
    </resultMap>

    <!-- 지원하기 -->
    <insert id="insert" parameterType="com.devmatch.dto.ApplicationDTO">
        INSERT INTO dm_application (
            application_id, posting_id, member_id, resume_id, 
            cover_letter, status, created_at, updated_at
        ) VALUES (
            dm_application_seq.NEXTVAL, #{postingId}, #{memberId}, #{resumeId},
            #{coverLetter}, 'PENDING', SYSDATE, SYSDATE
        )
    </insert>

    <!-- 단건 조회 -->
    <select id="findById" parameterType="Long" resultMap="applicationMap">
        SELECT a.*, 
               p.title as posting_title,
               p.company_name,
               m.name as applicant_name,
               m.email as applicant_email,
               r.title as resume_title
        FROM dm_application a
        JOIN dm_job_posting p ON a.posting_id = p.posting_id
        JOIN dm_member m ON a.member_id = m.member_id
        LEFT JOIN dm_resume r ON a.resume_id = r.resume_id
        WHERE a.application_id = #{applicationId}
    </select>

    <!-- 중복 지원 체크 -->
    <select id="findByPostingAndMember" resultMap="applicationMap">
        SELECT * FROM dm_application 
        WHERE posting_id = #{postingId} AND member_id = #{memberId}
    </select>

    <!-- 내 지원내역 (개발자용) -->
    <select id="findByMemberId" parameterType="Long" resultMap="applicationMap">
        SELECT a.*, 
               p.title as posting_title,
               p.company_name,
               r.title as resume_title
        FROM dm_application a
        JOIN dm_job_posting p ON a.posting_id = p.posting_id
        LEFT JOIN dm_resume r ON a.resume_id = r.resume_id
        WHERE a.member_id = #{memberId}
        ORDER BY a.created_at DESC
    </select>

    <!-- 채용공고별 지원자 목록 (의뢰인용) -->
    <select id="findByPostingId" parameterType="Long" resultMap="applicationMap">
        SELECT a.*, 
               m.name as applicant_name,
               m.email as applicant_email,
               r.title as resume_title
        FROM dm_application a
        JOIN dm_member m ON a.member_id = m.member_id
        LEFT JOIN dm_resume r ON a.resume_id = r.resume_id
        WHERE a.posting_id = #{postingId}
        ORDER BY a.created_at DESC
    </select>

    <!-- 의뢰인의 모든 공고 지원자 -->
    <select id="findByClientId" parameterType="Long" resultMap="applicationMap">
        SELECT a.*, 
               p.title as posting_title,
               p.company_name,
               m.name as applicant_name,
               m.email as applicant_email,
               r.title as resume_title
        FROM dm_application a
        JOIN dm_job_posting p ON a.posting_id = p.posting_id
        JOIN dm_member m ON a.member_id = m.member_id
        LEFT JOIN dm_resume r ON a.resume_id = r.resume_id
        WHERE p.member_id = #{clientId}
        ORDER BY a.created_at DESC
    </select>

    <!-- 상태 변경 -->
    <update id="updateStatus">
        UPDATE dm_application 
        SET status = #{status}, updated_at = SYSDATE
        WHERE application_id = #{applicationId}
    </update>

    <!-- 삭제 (지원 취소) -->
    <delete id="delete" parameterType="Long">
        DELETE FROM dm_application WHERE application_id = #{applicationId}
    </delete>

    <!-- 지원자 수 -->
    <select id="countByPostingId" parameterType="Long" resultType="int">
        SELECT COUNT(*) FROM dm_application WHERE posting_id = #{postingId}
    </select>

</mapper>
